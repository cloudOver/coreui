<!--
Copyright (c) 2014-2016 cloudover.io ltd.

This file is part of CloudOver project.

cloudover.coreCluster is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.

-->


<div class="ui container">
    <div class="ui segment">
        <div class="ui three column grid">
            <div class="column">
                <div class="ui icon header">
                    <i class="computer icon"></i>
                    {{ vm.name }}
                </div>
            </div>
            <div class="column">
                <div class="meta">ID: {{ vm.id }}</div>
                <div class="meta">Template: {{ vm.template.name }}<br/><small>Cpu: {{vm.template.cpu }}, memory: {{ vm.template.memory}}</small></div>
                <div class="meta">Base image: {{ vm.base_image.name }}</div>
                <div class="meta">State:
                    <i ng-show="vm.state == 'init'" class="blue settings icon"></i>
                    <i ng-show="vm.state == 'failed'" class="red remove icon"></i>
                    <i ng-show="vm.state == 'in progress'" class="green cloud upload icon"></i>
                    <i ng-show="vm.state == 'ok'" class="green checkmark icon"></i>
                    {{ vm.state }}
                </div>
                <div class="divider"></div>
                <div class="meta">Created: {{ vm.start_time }}</div>
                <div class="meta">Format: {{ vm.template.name }}</div>
                <div class="meta"><div class="ui toggle checkbox"><label>Remote console</label><input type="checkbox" name="vnc" ng-model="vm.vnc"/></div></div>
            </div>
            <div class="right aligned column">
                <div class="ui buttons">
                    <button class="ui red animated fade button" ng-click="vmCleanup()">
                        <div class="visible content"><i class="remove icon"></i></div>
                        <div class="hidden content">Remove</div>
                    </button>
                    <button class="ui green animated fade button" ng-click="vmStart()" ng-show="vm.state == 'stopped'">
                        <div class="visible content"><i class="play icon"></i></div>
                        <div class="hidden content">Start</div>
                    </button>
                    <button class="ui blue animated fade button" ng-click="vmReset()" ng-show="vm.state =='running'">
                        <div class="visible content"><i class="refresh icon"></i></div>
                        <div class="hidden content">Reset</div>
                    </button>
                    <button class="ui yellow animated fade button" ng-click="vmShutdown()" ng-show="vm.state == 'running'">
                        <div class="visible content"><i class="down arrow icon"></i></div>
                        <div class="hidden content">Shutdown</div>
                    </button>
                    <button class="ui yellow animated fade button" ng-click="vmPoweroff()" ng-show="vm.state == 'running'">
                        <div class="visible content"><i class="power icon"></i></div>
                        <div class="hidden content">Power off</div>
                    </button>
                    <button class="ui green animated fade button" ng-click="vmSaveImage()" ng-show="vm.state == 'stopped'">
                        <div class="visible content"><i class="save icon"></i></div>
                        <div class="hidden content">Save image</div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="ui styled fluid accordion">
        <div class="title active">
            <i class="dropdown icon"></i>
            Basic information
        </div>
        <div class="content active">
            <p style="display: block ! important;" class="transition visible">
                <div class="ui two column grid">
                    <div class="ui column form">
                        <div class="field">
                            <div class="ui left icon input">
                                <i class="edit icon"></i>
                                <input type="text" ng-model="vm.name" placeholder="Instance name">
                            </div>
                        </div>
                        <div class="field">
                            <div class="ui left icon input">
                                <i class="edit icon"></i>
                                <textarea rows=4 ng-model="vm.description" placeholder="Description"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="ui column">
                        <div class="ui header" ng-show="image.attached_to_id">
                            Attached as external drive to instance {{ image.attached_to }}
                            <button class="ui red button" ng-click="imageDetach(image.attached_to_id, image.id)">Detach</button>
                        </div>
                    </div>
                </div>
            </p>
        </div>
    </div>
</div>

<script>
    $('.ui.accordion').accordion();
</script>


<div class="text-center">
    <form id="create">
        <div class="row">
            <div class="col-md-5 col-sm-6">
                <!-- Virtual hardware -->
                <div class="panel panel-default">
                    <div class="panel-heading" onclick="$('#hardware').toggle();">
                        <span class="glyphicon glyphicon-wrench"></span> Virtual hardware and VNC <span class="glyphicon glyphicon-menu-down"></span>
                    </div>
                    <div class="panel-body" id="hardware" style="display: none">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="pull-right">Resources:</div>
                            </div>
                            <div class="col-md-8">
                                {{ vm.template.name }}<br/>
                                <small>Cpu: {{vm.template.cpu }}, memory: {{ vm.template.memory}}</small>
                            </div>
                        </div>
                        <hr/>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="pull-right">Base image:</div>
                            </div>
                            <div class="col-md-8">
                                {{ vm.base_image.name }}<br/>
                                <small>{{ vm.base_image.id }}</small>
                            </div>
                        </div>
                        <hr ng-show="vm.state == 'running'"/>
                        <div class="row" ng-show="vm.state == 'running'">
                            <div class="col-md-4">
                                <div class="pull-right">Remote screen:</div>
                            </div>
                            <div class="col-md-8">
                                <button class="btn btn-sm btn-success" ng-show="vm.vnc_enabled" ng-click="vmConsole(0)">Enabled</button>
                                <button class="btn btn-sm btn-default" ng-show="!vm.vnc_enabled" ng-click="vmConsole(1)">Disabled</button>

                                <br ng-show="vm.vnc_enabled"/>
                                <br ng-show="vm.vnc_enabled"/>
                                <div class="input-group input-group-sm" ng-show="vm.vnc_enabled">
                                    <span class="input-group-addon">Vnc address</span>
                                    <input type="text" id="vnc_addr" ng-attr-value="vnc://{{vm.vnc_address}}:{{vm.vnc_port}}" class="form-control" placeholder="Vnc port" readonly>
                                </div>
                                <br ng-show="vm.vnc_enabled"/>
                                <div class="input-group input-group-sm" ng-show="vm.vnc_enabled">
                                    <span class="input-group-addon">Vnc password</span>
                                    <input type="text" id="vnc_passwd" ng-model="vm.vnc_passwd" class="form-control" readonly>
                                </div>
                            </div>
                        </div>
                        <hr ng-show="vm.state == 'running'"/>
                        <div class="row" ng-show="vm.state == 'running'">
                            <div class="col-md-4">
                                <div class="pull-right">WebVNC console:</div>
                            </div>
                            <div class="col-md-8">
                                <!-- Button trigger modal -->
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm" data-toggle="modal" data-target="#noVNC">Open here</button>
                                    <a href="{{ webvnc_path }}" target="_blanc" type="button" class="btn btn-sm btn-success">Open in new window</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CoreTalk -->
                <div class="panel panel-default" id="coreTalkTab" style="display: none;">
                    <div class="panel-heading" onclick="$('#coretalk').toggle();">
                        <span class="glyphicon glyphicon-gift"></span></span> CloudInit script <span class="glyphicon glyphicon-menu-down"></span>
                    </div>
                    <div class="panel-body" id="coretalk" style="display: none">
                        <div class="form-inline">
                            <select ng-model="userdata" ng-options="script.name for script in userdata_scripts" class="form-control">
                                <option value="">-- select script --</option>
                            </select>
                            <button class="btn btn-success" ng-click="coreTalkAttach()">Attach</button>
                        </div>
                    </div>
                </div>

                <!-- Network interfaces -->
                <div class="panel panel-default">
                    <div class="panel-heading" onclick="$('#networks').toggle();">
                        <span class="glyphicon glyphicon-globe"></span></span> Network interfaces <span class="glyphicon glyphicon-menu-down"></span>
                    </div>
                    <div class="panel-body" id="networks" style="display: none">
                        <table class="table table-striped">
                            <thead>
                                <th>Network</th>
                                <th>IPv4</th>
                                <th></th>
                            </thead>
                            <tr data-ng-repeat="lease in vm.leases">
                                <td>{{ lease.subnet_id }}</td>
                                <td>{{ lease.address }}</td>
                                <td><button ng-click="networkDetach(lease.id)" ng-show="vm.state == 'stopped'" class="btn btn-sm btn-danger"><span class="glyphicon glyphicon-remove"></span></button></td>
                            </tr>
                        </table>

                        <!-- Attach -->
                        <div class="row" ng-show="vm.state == 'stopped'">
                            <div class="col-md-10">
                                <select ng-model="network_attach_lease" ng-options="lease.address for lease in leases | filter:{vm_id: null}" class="form-control">
                                    <option value="">-- select lease --</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-success btn-block" ng-click="networkAttach(network_attach_lease)"><span class="glyphicon glyphicon-plus"></span></button>
                            </div>
                        </div>
                        <small ng-show="vm.state != 'stopped'">You can attach and detach network interfaces when VM is stopped</small>
                    </div>
                </div>

                <!-- External storages -->
                <div class="panel panel-default">
                    <div class="panel-heading" onclick="$('#storages').toggle();">
                        <span class="glyphicon glyphicon-hdd"></span> External storages <span class="glyphicon glyphicon-menu-down"></span>
                    </div>
                    <div class="panel-body" id="storages" style="display: none">
                        <table class="table table-striped">
                            <thead>
                            <th>Name</th>
                            <th>Size</th>
                            <th>Index</th>
                            </thead>
                            <tr data-ng-repeat="disk in vm.disks">
                                <td>{{ disk.name }}</td>
                                <td>{{ disk.size/1024/1024/1024 }} GB</td>
                                <td>{{ disk.disk_dev }}</td>
                            </tr>
                        </table>

                        <!-- Attach -->
                        <div class="row" ng-show="vm.state == 'stopped'">
                            <div class="col-md-10">
                                <select ng-model="image_attach_object" ng-options="image.name for image in images | filter:{type: 'permanent', attached_to_id: null, state: 'ok'}" class="form-control" required="">
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-sm btn-success btn-block" ng-click="imageAttach(image_attach_object)"><span class="glyphicon glyphicon-plus"></span></button>
                            </div>
                        </div>
                        <small ng-show="vm.state != 'stopped'">You can attach and detach storages when VM is stopped</small>
                    </div>
                </div>

                <!-- Additional options -->
                <div class="panel panel-default">
                    <div class="panel-heading" onclick="$('#data').toggle();">
                        <span class="glyphicon glyphicon-plus"></span> Additional options <span class="glyphicon glyphicon-menu-down"></span>
                    </div>
                    <div class="panel-body" id="data" style="display: none">
                        <table class="table table-striped">
                            <thead>
                            <th>Name</th>
                            <th>Value</th>
                            </thead>
                            <tr data-ng-repeat="(k, v) in vm.data">
                                <td>{{k}}</td>
                                <td><pre>{{ v|json }}</pre></td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- Tasks -->
                <div class="panel panel-default">
                    <div class="panel-heading" onclick="$('#tasks').toggle();">
                        <span class="glyphicon glyphicon-list-alt"></span> Tasks <span class="glyphicon glyphicon-menu-down"></span>
                    </div>
                    <div class="panel-body text-center" id="tasks" style="display: none">
                        <table class="table table-striped">
                            <thead>
                            <th>Type</th>
                            <th>Action</th>
                            <th>State</th>
                            </thead>
                            <tr data-ng-repeat="task in vm.tasks" ng-class="{danger: task.state=='failed', success: task.state=='in progress', warning: task.state=='not active'}">
                                <td>{{task.type}}</td>
                                <td>{{task.action}}</td>
                                <td>{{task.state}}</td>
                            </tr>
                        </table>
                        <div id="task_graph" style="height: 400px; width: 100%;"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-1 hidden-sm"></div>
        </div>

        <a href="#/api/vm/">Go back to instances list</a>
        &nbsp;&nbsp;&nbsp;
        <button type="submit" ng-click="vmSave()" class="btn btn-lg btn-success">Save</button>
    </form>
</div>

<div class="modal fade" tabindex="-1" role="dialog" id="noVNC">
    <div class="fluid modal-dialog modal-lg">
        <div class="fluid modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title">Web VNC console</h4>
            </div>
            <div class="modal-body">
                <iframe src="{{ webvnc_path }}" width="850px" height="700px" id="noVNC_frame"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->