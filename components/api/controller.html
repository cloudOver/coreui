<div id="modals"></div>

<script type="text/javascript">
    $("#modals").append($("<div>").load("components/api/modals/image_upload.html"));
    $("#modals").append($("<div>").load("components/api/modals/image_create.html"));
    $("#modals").append($("<div>").load("components/api/modals/network_create.html"));
    $("#modals").append($("<div>").load("components/api/modals/vm_create.html"));

    /// VM Tab

    function showVmList() {
        highlightMenu("#vm_list");
        request("/api/vm/get_list/", {token: window.token}, function(r) {
            makeTable(new TableCoreModel(r, ["name", "description", "state", "start_time"], "vm"), "#content");
            refreshContent("showVmList()");
        });
    }

    function showTemplateList() {
        highlightMenu("#template_list");
        clearTimeout(window.refresh_timeout);
        request("/api/template/get_list/", {token: window.token}, function(r) {
            makeTable(new TableCoreModel(r, ["name", "domain_type", "cpu", "memory", "points"], "template"), "#content");
        });
    }

    function showVmCreate() {
        highlightMenu("#vm_create");
        showVmList();
        modal = "#vmCreateModal";
        $(modal).on('show.bs.modal', function(e) {
            request('/api/template/get_list/', {token: window.token}, function (r) {
                fillSelect(new SelectCoreModel(r, "name"), modal, "#vmTemplate");
            });
            request('/api/image/get_list/', {token: window.token, type: 'transient'}, function (r) {
                fillSelect(new SelectCoreModel(r, "name"), modal, "#vmImage");
            });
            request('/api/network/list_user_networks/', {token: window.token}, function(nets) {
                $(modal).find("#vmLeases").empty();
                for (i = 0; i < nets.length; i++) {
                    $(modal).find("#vmLeases").append("<optgroup id='network_leases_" + nets[i]["id"] + "' label='" + nets[i]["name"] + "'></optgroup>");
                    request('/api/network/list_leases/', {token: window.token, network_id: nets[i]["id"]}, function(r) {
                        // Remove attached leases
                        for (l = r.length-1; l >= 0; l--) {
                            if (r[l]["vm_id"] > 0) {
                                r.splice(l, 1);
                            }
                        }
                        fillSelect(new SelectCoreModel(r, "address"), modal, "#network_leases_" + r[0]['user_network_id']);
                        $(modal).find("#vmLeases").selectator();
                    });
                }
                $(modal).find("#vmLeases").selectator();
            });
            request('/api/image/get_list/', {token: window.token, type: 'permanent'}, function (r) {
                // Remove attached disks
                for (l = r.length-1; l >= 0; l--) {
                    if (r[l]["vm_id"] > 0) {
                        r.splice(l, 1);
                    }
                }
                fillSelect(new SelectCoreModel(r, "name"), modal, "#vmDisks");
            });
        });
        $(modal).modal('show');
    }

    /// Image Tab

    function showImageList() {
        highlightMenu("#image_list");
        request("/api/image/get_list/", {token: window.token}, function(r) {
            makeTable(new TableCoreModel(r, ["name", "description", "size", "state", "access"], "image"), "#content");
            refreshContent("showImageList()");
        });
    }

    function showImageCreate() {
        highlightMenu("#image_create");
        showImageList();
        modal = "#imageCreateModal";
        $(modal).on('show.bs.modal', function(e) {
            request('/api/image/get_image_formats/', {token: window.token}, function (r) {
                fillSelect(new SelectListModel(r), modal, "#imageFormat");
            });
            request('/api/image/get_image_types/', {token: window.token}, function (r) {
                fillSelect(new SelectListModel(r), modal, "#imageType");
            });
            request('/api/image/get_disk_controllers/', {token: window.token}, function (r) {
                fillSelect(new SelectListModel(r), modal, "#imageDiskController");
            });
        });
        $(modal).modal('show');
    }

    function showImageUpload() {
        highlightMenu("#image_upload");
        showImageList();
        modal = "#imageUploadModal";
        $(modal).on('show.bs.modal', function(e) {
            request('/api/image/get_image_formats/', {token: window.token}, function (r) {
                fillSelect(new SelectListModel(r), modal, "#imageFormat");
            });
            request('/api/image/get_image_types/', {token: window.token}, function (r) {
                fillSelect(new SelectListModel(r), modal, "#imageType");
            });
            request('/api/image/get_disk_controllers/', {token: window.token}, function (r) {
                fillSelect(new SelectListModel(r), modal, "#imageDiskController");
            });
        });
        $(modal).modal('show');
    }

    /// Network Tab

    function showNetworkList() {
        highlightMenu("#network_list");
        clearTimeout(window.refresh_timeout);
        request("/api/network/list_user_networks/", {token: window.token}, function(r) {
            makeTable(new TableCoreModel(r, ["id", "name", "address", "mask"], "network"), "#content");
        });
    }

    function showNetworkCreate() {
        highlightMenu("#network_create");
        showNetworkList();
        modal = "#networkCreateModal";
        $(modal).modal('show');
    }



    $("#vm_list").click(function(e) { showVmList(); });
    $("#template_list").click(function(e) { showTemplateList(); });
    $("#vm_create").click(function(e) { showVmCreate() });

    $("#image_list").click(function(e) { showImageList() });
    $("#image_create").click(function(e) { showImageCreate() });
    $("#image_upload").click(function(e) { showImageUpload() });

    $("#network_list").click(function(e) { showNetworkList() });
    $("#network_create").click(function(e) { showNetworkCreate() });
</script>
