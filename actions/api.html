<script type="jquery-xtmpl" id="imageInfoTmpl">
<div class="row">
    <div id="form_${id}" class="col-md-3">
        <div class="form-group">
            <label for="image_type_${id}">Image type:</label>
            <select id=image_type_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_access_${id}">Access:</label>
            <select id=image_access_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_disk_${id}">Disk controller:</label>
            <select id=image_disk_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_video_${id}">Virtual video graphics card:</label>
            <select id=image_video_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_network_${id}">Virtual network card driver:</label>
            <select id=image_network_${id} class="form-control chosen-select"></select>
        </div>
        <script type="text/javascript">
            function imageRemove() {
                request("/api/image/delete/", {token: window.token, image_id: ${id}}, function() {
                    showImageList();
                });
            }
        {{html "</sc"+"ript>"}}
    </div>
    <div id="form_${id}" class="col-md-7">
        <div id="imageTasks_${id}"></div>
    </div>
    <div class="col-md-2 btn-group-vertical btn-group-sm">
        <button onclick='imageRemove()' id="remove_${id}" class='btn btn-danger'><span class='glyphicon glyphicon-remove'></span></button>
    </div>
</div>
</script>

<script type="jquery-xtmpl" id="networkInfoTmpl">
    <div class="btn-group-vertical btn-group-sm">
        <button onclick='networkRemove()' id="remove_${id}" class='btn btn-danger'><span class='glyphicon glyphicon-remove'></span></button>
        <script type="text/javascript">
            function networkRemove() {
                request("/api/network/release/", {token: window.token, network_id: ${id}}, function() {
                    showNetworkList();
                });
            }
        {{html "</sc"+"ript>"}}
    </div>
</script>

<div id="apiModals"></div>

<script type="text/javascript">
    function showActions_image(id) {
        if ($("#actions_" + id).hasClass("hidden")) {
            $("#actions_" + id).empty();
            $("#actions_" + id).append("<div class='btn-group btn-group-sm'>");
            var ids = [
                {id: id}
            ];
            $("#imageInfoTmpl").tmpl(ids).appendTo("#actions_" + id);
            $("#actions_" + id).removeClass("hidden");
            clearTimeout(window.refresh_timeout);
            makeFieldEditable(id, 'image', 'name');
            makeFieldEditable(id, 'image', 'description');

            request("/api/image/get_by_id/", {token: window.token, image_id: id}, function(image) {
                // Fill tasks
                makeTable(new TableCoreModel(image['tasks'], ["type", "action", "state", "creation_time"], null), "#imageTasks_" + id);

                // Show access
                fillSelect(new SelectListModel(['private', 'group', 'public'], image.type), "#form_" + id, "#image_access_" + id);
                $("#image_access_" + id).change(function () {
                    request('/api/image/edit/', {token: window.token, image_id: id, access: $("#image_access_" + id).val()}, function () {
                    });
                }).selectator();

                // Show types
                request("/api/image/get_image_types/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.type), "#form_" + id, "#image_type_" + id);

                    $("#image_type_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, type: $("#image_type_" + id).val()}, function () {
                        });
                    }).selectator();
                });

                // Show video devices
                request("/api/image/get_video_devices/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.video_device), "#form_" + id, "#image_video_" + id);

                    $("#image_video_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, video_device: $("#image_video_" + id).val()}, function () {
                        });
                    }).selectator();
                });

                // Show network devices
                request("/api/image/get_network_devices/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.network_device), "#form_" + id, "#image_network_" + id);

                    $("#image_network_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, network_device: $("#image_network_" + id).val()}, function () {
                        });
                    }).selectator();
                });

                // Show disk controllers
                request("/api/image/get_disk_controllers/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.disk_controller), "#form_" + id, "#image_disk_" + id);

                    $("#image_disk_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, disk_controller: $("#image_disk_" + id).val()}, function () {
                        });
                    }).selectator();
                });
            });
        } else {
            $("#actions_" + id).addClass("hidden");
            makeFieldUneditable(id, 'name');
            makeFieldUneditable(id, 'description');
        }
    }

    function showActions_network(id) {
        if ($("#actions_" + id).hasClass("hidden")) {
            $("#actions_" + id).empty();
            var ids = [
                {id: id}
            ];
            $("#networkInfoTmpl").tmpl(ids).appendTo("#actions_" + id);
            $("#actions_" + id).removeClass("hidden");
            clearTimeout(window.refresh_timeout);
            makeFieldEditable(id, 'network', 'name');
        } else {
            $("#actions_" + id).addClass("hidden");
            makeFieldUneditable(id, 'name');
        }
    }

    function showActions_template(id) {
    }

    function showActions_vm(id) {
        $("#apiModals").load('components/api/modals/vm_info.html', function() {
            $('#vmDetails').toggle(1)
            $('#vmAttach').toggle(1);
            $("#vmInfoModal").modal('show');

            $(function () {
                $("[data-toggle='tooltip']").tooltip();
            });

            $("#reset").click(function() {request("/api/vm/reset/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#cleanup").click(function() {request("/api/vm/cleanup/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#shutdown").click(function() {request("/api/vm/shutdown/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#poweroff").click(function() {request("/api/vm/poweroff/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#save").click(function() {request("/api/vm/save_image/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#start").click(function() {request("/api/vm/start/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});

            request('/api/image/get_list/', {token: window.token}, function (r) {
                fillSelect(new SelectCoreModel(r, "name"), modal, "#vmAttachImage");
            });

            request('/api/vm/get_by_id/', {token: window.token, vm_id: id}, function(r) {
                $("#vmInfoName").append(r['name']);
                $("#vmInfoDescription").append(r['description']);
                $("#vmInfoState").append(r['state']);
                $("#vmInfoID").append(r['id']);


                makeFieldEditableId(id, "vm", "name", "#vmInfoName");
                makeFieldEditableId(id, "vm", "description", "#vmInfoDescription");

                makeTable(new TableCoreModel(r['tasks'], ["type", "action", "state"], null), "#vmTasks");
                makeTable(new TableCoreModel(r['leases'], ["address"], null), "#vmLeases");
                makeTable(new TableCoreModel(r['disks'], ["name", "disk_dev", "disk_controller"], null), "#vmDisks");
                if (r["state"] == "running") {
                    if (r["vnc_enabled"] == true) {
                        $("#console").addClass("btn-success");
                    } else {
                        $("#console").addClass("btn-default");
                    }
                    $("#reset").removeClass("hidden");
                    $("#poweroff").removeClass("hidden");
                    $("#shutdown").removeClass("hidden");
                } else if (r["state"] == "stopped") {
                    $("#save").removeClass("hidden");
                    $("#cleanup").removeClass("hidden");
                    $("#console").removeClass("hidden");
                    $("#start").removeClass("hidden");
                } else {
                    $("#cleanup").removeClass("hidden");
                }

                $("#vncPassword").append(r['vnc_passwd']);
                $("#vncHost").val(r['vnc_address'] + ':' + r['vnc_port']);
            });

            request('/api/image/get_list/', {token: window.token, type: 'permanent'}, function (r) {
                // Remove attached disks
                for (l = r.length-1; l <= 0; l--) {
                    if (r[l]["vm_id"] > 0) {
                        r.splice(l, 1);
                    }
                }
                fillSelect(new SelectCoreModel(r, "name"), modal, "#vmAttachDisks");
            });
        });
    }
</script>