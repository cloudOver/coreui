<script type="jquery-xtmpl" id="networkInfoTmpl">
    <div class="btn-group-vertical btn-group-sm">
        <button onclick='networkRemove()' id="remove_${id}" class='btn btn-danger'><span class='glyphicon glyphicon-remove'></span></button>
        <script type="text/javascript">
            function networkRemove() {
                request("/api/network/release/", {token: window.token, network_id: ${id}}, function() {
                    showNetworkList();
                });
            }
        {{html "</sc"+"ript>"}}
    </div>
</script>

<div id="apiModals"></div>

<script type="text/javascript">
    function showActions_image(id) {
        $("#apiModals").load('components/api/modals/image_info.html', function() {
            $('#imageDetails').toggle(1);
            $("#imageInfoModal").modal('show');

            $(function () {
                $("[data-toggle='tooltip']").tooltip();
            });

            $("#remove").click(function() {request("/api/image/delete/", {token: window.token, image_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showImageList()});

            request('/api/image/get_by_id/', {token: window.token, image_id: id}, function(image) {
                $("#imageInfoName").append(image['name']);
                $("#imageInfoDescription").append(image['description']);
                $("#imageInfoState").append(image['state']);
                $("#imageInfoID").append(image['id']);
                $("#imageInfoAttachedTo").empty();
                $("#imageInfoAttachedTo").append(image['attached_to_id']);


                makeFieldEditableId(id, "image", "name", "#imageInfoName");
                makeFieldEditableId(id, "image", "description", "#imageInfoDescription");

                makeTable(new TableCoreModel(image['tasks'], ["type", "action", "state"], null), "#vmTasks");

                // Show access
                fillSelect(new SelectListModel(['private', 'group', 'public'], image.access), "#imageForm", "#image_access");
                $("#image_access").change(function () {
                    request('/api/image/edit/', {token: window.token, image_id: id, access: $("#image_access").val()}, function () {});
                }).selectator();

                // Show types
                request("/api/image/get_image_types/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.type), "#imageForm", "#image_type");
                    $("#image_type").change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, type: $("#image_type").val()}, function () {});
                    }).selectator();
                });
                // Show video devices
                request("/api/image/get_video_devices/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.video_device), "#imageForm", "#image_video");
                    $("#image_video").change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, video_device: $("#image_video").val()}, function () {});
                    }).selectator();
                });
                // Show network devices
                request("/api/image/get_network_devices/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.network_device), "#imageForm", "#image_network");
                    $("#image_network").change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, network_device: $("#image_network").val()}, function () {
                        });
                    }).selectator();
                });
                // Show disk controllers
                request("/api/image/get_disk_controllers/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.disk_controller), "#imageForm", "#image_disk");
                    $("#image_disk").change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, disk_controller: $("#image_disk").val()}, function () {
                        });
                    }).selectator();
                });

                request('/api/vm/get_list/', {token: window.token}, function (r) {
                    // Remove not stopped vms
                    for (l = r.length-1; l >= 0; l--) {
                        if (r[l]["state"] == "closed" || r[l]["base_image"]["id"] != id) {
                            r.splice(l, 1);
                        }
                    }
                    makeTable(new TableCoreModel(r, ["name"], null), "#vmImageBase");
                });
            });
        });
    }

    function showActions_network(id) {
        if ($("#actions_" + id).hasClass("hidden")) {
            $("#actions_" + id).empty();
            var ids = [
                {id: id}
            ];
            $("#networkInfoTmpl").tmpl(ids).appendTo("#actions_" + id);
            $("#actions_" + id).removeClass("hidden");
            clearTimeout(window.refresh_timeout);
            makeFieldEditable(id, 'network', 'name');
        } else {
            $("#actions_" + id).addClass("hidden");
            makeFieldUneditable(id, 'name');
        }
    }

    function showActions_template(id) {
    }

    function showActions_vm(id) {
        $("#apiModals").load('components/api/modals/vm_info.html', function() {
            $('#vmDetails').toggle(1)
            $('#vmAttach').toggle(1);
            $("#vmInfoModal").modal('show');

            $(function () {
                $("[data-toggle='tooltip']").tooltip();
            });

            $("#reset").click(function() {request("/api/vm/reset/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#cleanup").click(function() {request("/api/vm/cleanup/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#shutdown").click(function() {request("/api/vm/shutdown/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#poweroff").click(function() {request("/api/vm/poweroff/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#save").click(function() {request("/api/vm/save_image/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});
            $("#start").click(function() {request("/api/vm/start/", {token: window.token, vm_id: id}, function(){}); $("#vmInfoModal").modal('hide'); showVmList()});

            request('/api/vm/get_by_id/', {token: window.token, vm_id: id}, function(r) {
                $("#vmInfoName").append(r['name']);
                $("#vmInfoDescription").append(r['description']);
                $("#vmInfoState").append(r['state']);
                $("#vmInfoID").append(r['id']);


                makeFieldEditableId(id, "vm", "name", "#vmInfoName");
                makeFieldEditableId(id, "vm", "description", "#vmInfoDescription");

                makeTable(new TableCoreModel(r['tasks'], ["type", "action", "state"], null), "#vmTasks");
                makeTable(new TableCoreModel(r['leases'], ["address"], null), "#vmLeases");
                makeTable(new TableCoreModel(r['disks'], ["name", "disk_dev", "disk_controller"], null), "#vmDisks");
                if (r["state"] == "running") {
                    if (r["vnc_enabled"] == true) {
                        $("#console").addClass("btn-success");
                        $("#console").click(function() {request("/api/vm/console/", {token: window.token, vm_id: id, enable: 1}, function(){} )});
                    } else {
                        $("#console").addClass("btn-default");
                        $("#console").click(function() {request("/api/vm/console/", {token: window.token, vm_id: id, enable: 1}, function(){} )});
                    }
                    $("#vm_running").removeClass("hidden");
                    $("#vm_stopped").addClass("hidden");
                } else if (r["state"] == "stopped") {
                    $("#vm_running").addClass("hidden");
                    $("#vm_stopped").removeClass("hidden");
                } else {
                    $("#cleanup").removeClass("hidden");
                }

                $("#vncPassword").append(r['vnc_passwd']);
                $("#vncHost").val(r['vnc_address'] + ':' + r['vnc_port']);
            });

            request('/api/image/get_list/', {token: window.token, type: 'permanent'}, function (r) {
                // Remove attached disks
                for (l = r.length-1; l >= 0; l--) {
                    if (r[l]["attached_to_id"] > 0) {
                        r.splice(l, 1);
                    }
                }
                fillSelect(new SelectCoreModel(r, "name"), modal, "#vmAttachDisks");
            });
        });
    }
</script>