<script type="jquery-xtmpl" id="imageInfoTmpl">
<div class="row">
    <div id="form_${id}" class="col-md-3">
        <div class="form-group">
            <label for="image_type_${id}">Image type:</label>
            <select id=image_type_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_access_${id}">Access:</label>
            <select id=image_access_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_disk_${id}">Disk controller:</label>
            <select id=image_disk_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_video_${id}">Virtual video graphics card:</label>
            <select id=image_video_${id} class="form-control chosen-select"></select>
        </div>
        <div class="form-group">
            <label for="image_network_${id}">Virtual network card driver:</label>
            <select id=image_network_${id} class="form-control chosen-select"></select>
        </div>
        <script type="text/javascript">
            function imageRemove() {
                request("/api/image/delete/", {token: window.token, image_id: ${id}}, function() {
                    showImageList();
                });
            }
        {{html "</sc"+"ript>"}}
    </div>
    <div id="form_${id}" class="col-md-7">
        <div id="imageTasks_${id}"></div>
    </div>
    <div class="col-md-2 btn-group-vertical btn-group-sm">
        <button onclick='imageRemove()' id="remove_${id}" class='btn btn-danger'><span class='glyphicon glyphicon-remove'></span></button>
    </div>
</div>
</script>

<script type="jquery-xtmpl" id="networkInfoTmpl">
    <div class="btn-group-vertical btn-group-sm">
        <button onclick='networkRemove()' id="remove_${id}" class='btn btn-danger'><span class='glyphicon glyphicon-remove'></span></button>
        <script type="text/javascript">
            function networkRemove() {
                request("/api/network/release/", {token: window.token, network_id: ${id}}, function() {
                    showNetworkList();
                });
            }
        {{html "</sc"+"ript>"}}
    </div>
</script>

<script type="jquery-xtmpl" id="vmInfoTmpl">
<div class="row">
    <div class="col-md-4">
        <div class="form-group well">
            <label>Assigned tasks:</label>
            <div id="vmTasks_${id}"></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="form-group well">
            <label>IPv4 addresses:</label>
            <div id="vmLeases_${id}"></div>
        </div>
        <div class=form-group>
            <label>Permanent disks:</label>
            <div id="vmDisks_${id}"></div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="btn-group btn-group-sm">
            <button onclick='vmCleanup()' id="cleanup_${id}" class='btn btn-primary' data-toggle="tooltip" data-placement="bottom" title="Cleanup VM's data"><span class='glyphicon glyphicon-remove'></span></button>
            <button onclick='vmSave()' id="save_${id}" class='btn btn-primary' data-toggle="tooltip" data-placement="bottom" title="Save VM base image"><span class='glyphicon glyphicon-floppy-disk'></span></button>
        </div>
        <div class="btn-group btn-group-sm">
            <button onclick='vmStart()' id="start_${id}" class='btn btn-success' data-toggle="tooltip" data-placement="bottom" title="Start VM"><span class='glyphicon glyphicon-play'></span></button>
            <button onclick='vmPoweroff()' id="poweroff_${id}" class='btn btn-warning' data-toggle="tooltip" data-placement="bottom" title="Power off"><span class='glyphicon glyphicon-off'></span></button>
            <button onclick='vmShutdown()' id="shutdown_${id}" class='btn btn-warning' data-toggle="tooltip" data-placement="bottom" title="Shutdown (ACPI button)"><span class='glyphicon glyphicon-circle-arrow-down'></span></button>
            <button onclick='vmReset()' id="reset_${id}" class='btn btn-warning' data-toggle="tooltip" data-placement="bottom" title="Reset"><span class='glyphicon glyphicon-refresh'></span></button>
        </div>
        <hr/>
        <div class="form-inline">
            <div class="input-group">
                <span class="input-group-addon">vnc://</span>
                <input type=text class=form-control id=vncHost_${id} />
            </div>
            <span onclick='toggleVnc()' id="console_${id}" class='btn' data-toggle="tooltip" data-placement="bottom" title="Toggle vnc console"><span class='glyphicon glyphicon-picture'></span></span>

            <div class="input-group" id=vncPassword_${id}>
                <label>Password: </label>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    function vmStart() {
        request("/api/vm/start/", {token: window.token, vm_id: ${id}}, function() {
            showVmList();
        });
    }
    function vmReset() {
        request("/api/vm/reset/", {token: window.token, vm_id: ${id}}, function() {
            showVmList();
        });
    }
    function vmCleanup() {
        request("/api/vm/cleanup/", {token: window.token, vm_id: ${id}}, function() {
            showVmList();
        });
    }
    function vmPoweroff() {
        request("/api/vm/poweroff/", {token: window.token, vm_id: ${id}}, function() {
            showVmList();
        });
    }
    function vmShutdown() {
        request("/api/vm/shutdown/", {token: window.token, vm_id: ${id}}, function() {
            showVmList();
        });
    }
    function vmSave() {
        request("/api/vm/save_image/", {token: window.token, vm_id: ${id}}, function() {
            showVmList();
        });
    }
    function toggleVnc() {
        request("/api/vm/console/", {token: window.token, vm_id: ${id}, enable: 1}, function(r) {
            showVmList();
        });
    }
{{html "</sc"+"ript>"}}
</script>

<script type="text/javascript">
    function showActions_image(id) {
        if ($("#actions_" + id).hasClass("hidden")) {
            $("#actions_" + id).empty();
            $("#actions_" + id).append("<div class='btn-group btn-group-sm'>");
            var ids = [
                {id: id}
            ];
            $("#imageInfoTmpl").tmpl(ids).appendTo("#actions_" + id);
            $("#actions_" + id).removeClass("hidden");
            clearTimeout(window.refresh_timeout);
            makeFieldEditable(id, 'image', 'name');
            makeFieldEditable(id, 'image', 'description');

            request("/api/image/get_by_id/", {token: window.token, image_id: id}, function(image) {
                // Fill tasks
                makeTable(new TableCoreModel(image['tasks'], ["type", "action", "state", "creation_time"], null), "#imageTasks_" + id);

                // Show access
                fillSelect(new SelectListModel(['private', 'group', 'public'], image.type), "#form_" + id, "#image_access_" + id);
                $("#image_access_" + id).change(function () {
                    request('/api/image/edit/', {token: window.token, image_id: id, access: $("#image_access_" + id).val()}, function () {
                    });
                }).selectator();

                // Show types
                request("/api/image/get_image_types/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.type), "#form_" + id, "#image_type_" + id);

                    $("#image_type_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, type: $("#image_type_" + id).val()}, function () {
                        });
                    }).selectator();
                });

                // Show video devices
                request("/api/image/get_video_devices/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.video_device), "#form_" + id, "#image_video_" + id);

                    $("#image_video_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, video_device: $("#image_video_" + id).val()}, function () {
                        });
                    }).selectator();
                });

                // Show network devices
                request("/api/image/get_network_devices/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.network_device), "#form_" + id, "#image_network_" + id);

                    $("#image_network_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, network_device: $("#image_network_" + id).val()}, function () {
                        });
                    }).selectator();
                });

                // Show disk controllers
                request("/api/image/get_disk_controllers/", {token: window.token}, function(r) {
                    fillSelect(new SelectListModel(r, image.disk_controller), "#form_" + id, "#image_disk_" + id);

                    $("#image_disk_" + id).change(function () {
                        request('/api/image/edit/', {token: window.token, image_id: id, disk_controller: $("#image_disk_" + id).val()}, function () {
                        });
                    }).selectator();
                });
            });
        } else {
            $("#actions_" + id).addClass("hidden");
            makeFieldUneditable(id, 'name');
            makeFieldUneditable(id, 'description');
        }
    }

    function showActions_network(id) {
        if ($("#actions_" + id).hasClass("hidden")) {
            $("#actions_" + id).empty();
            var ids = [
                {id: id}
            ];
            $("#networkInfoTmpl").tmpl(ids).appendTo("#actions_" + id);
            $("#actions_" + id).removeClass("hidden");
            clearTimeout(window.refresh_timeout);
            makeFieldEditable(id, 'network', 'name');
        } else {
            $("#actions_" + id).addClass("hidden");
            makeFieldUneditable(id, 'name');
        }
    }

    function showActions_template(id) {
    }

    function showActions_vm(id) {
        if ($("#actions_" + id).hasClass("hidden")) {
            $("#actions_" + id).empty();
            var ids = [
                {id: id}
            ];
            $("#vmInfoTmpl").tmpl(ids).appendTo("#actions_" + id);
            $("#actions_" + id).removeClass("hidden");
            clearTimeout(window.refresh_timeout);
            makeFieldEditable(id, 'vm', 'name');
            makeFieldEditable(id, 'vm', 'description');

            request('/api/vm/get_by_id/', {token: window.token, vm_id: id}, function(r) {
                makeTable(new TableCoreModel(r['tasks'], ["type", "action", "state"], null), "#vmTasks_" + id);
                makeTable(new TableCoreModel(r['leases'], ["address"], null), "#vmLeases_" + id);
                makeTable(new TableCoreModel(r['disks'], ["name", "disk_dev", "disk_controller"], null), "#vmDisks_" + id);
                if (r["vnc_enabled"] == true) {
                    $("#console_" + id).addClass("btn-success");
                } else {
                    $("#console_" + id).addClass("btn-default");
                }

                $("#vncPassword_" + id).append(r['vnc_passwd']);
                $("#vncHost_" + id).val(r['vnc_address'] + ':' + r['vnc_port']);
            });

            $(function () {
                $("[data-toggle='tooltip']").tooltip();
            });
        } else {
            $("#actions_" + id).addClass("hidden");
            makeFieldUneditable(id, 'name');
            makeFieldUneditable(id, 'description');
        }
    }
</script>